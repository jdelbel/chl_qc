---
title: "HPLC QC"
output: html_notebook
---

Working on a way to QC all of the HPLC data. Here, I am focusing on QU39.


```{r}
#Upload packages
library(tidyverse)
library(here)
library(patchwork)
library(readxl)
```

```{r}
#Uploading Chlorophyll -  the date is the upload date from the portal
chl <- read_csv(here("files", "chl_2023-01-09.csv"))

#Upload HPLC data
hplc <- read_csv(here("files", "hplc_qu39_2023-01-04_2.csv"))

```

```{r}
#Selecting relevant columns
chl <- chl %>% 
  select(date, site_id, survey, line_out_depth, collected, analyzed, hakai_id, 
         calibration:calibration_slope, filter_type, before_acid, after_acid,
         acid_flag, dilution_factor, chla, chla_flag, phaeo, phaeo_flag) 

#Adding month column
chl <- chl %>% 
  mutate(month = lubridate::month(date)) %>% 
  relocate(month, .after = date)
```

```{r}
#Wrangling hplc dataset

#Selecting important columns and limiting to records with results
hplc <- hplc %>% 
  filter(!is.na(all_chl_a)) %>% 
  select(date, collected, id_hplc = hakai_id,
         analyzed_hplc = analyzed, line_out_depth, all_chl_a)
```



```{r}
#Pulling out all samples that haven't been QC'd on the new module. 
# chl_qc <- chl %>% 
#   filter(!is.na(analyzed) &
#            (is.na(chla_flag) | chla_flag == "AV" | chla_flag == "ADL"))
```


```{r}
#Pulling out the bulk filters
chl_bulk <- chl %>% 
  filter(filter_type == "Bulk GF/F")

```


```{r}
#Joining HPLC with chlorophyll

#Doing full join so that all data is included. 
bulk_hplc <- chl_bulk %>% 
  full_join(hplc)

#Making HPLC analyzed date_time into just date.
bulk_hplc <- bulk_hplc %>% 
  mutate(analyzed_hplc = lubridate::date(analyzed_hplc))

```
```{r}

#Making a shipment column so that I can filter by shipment. In 2022, two shipments were sent back to back. Blow are the samples that were sent in the second shipment. There was no easier way to do this because they were all analyzed on the same day and there was not other differentiating information

ship_2_list <- c("QX9927", "QX9928", "QX9929", "QX9930", "QX9442", "QX9443",
                 "QX9444", "QX9445", "QX9447", "QX9448", "QX9449", "QX9450",
                 "QX9451", "QX9452", "QX9453", "QX9455", "QX9456", "QX9457",
                 "QX9458", "QX9459", "QX9460", "QX9461", "QX9463", "QX9464", 
                 "QX9465", "QX9466", "QX9467", "QX9468", "QX9469", "QX9471",
                 "QX9472", "QX9473", "QX9474", "QX9475", "QX9476", "QX9477",
                 "QX9479", "QX9480", "QX9481", "QX9482", "QX9483", "QX9484",
                 "QX9485", "QX9487", "QX9488", "QX9489", "QX9490", "QX9491",
                 "QX9492", "QX9493", "QX9932", "QX9933", "QX9934", "CX8411",
                 "CX8412", "QX9938", "QX9939", "QX9940", "QX9941")

bulk_hplc <- bulk_hplc %>% 
  mutate(shipment = case_when(analyzed_hplc == "2022-11-30" & 
                                id_hplc %in% ship_2_list ~ "2022-11-2",
                              analyzed_hplc == "2022-11-30" & 
                                !id_hplc %in% ship_2_list ~ "2022-11-1",
                              analyzed_hplc > "2021-01-01" & 
                              analyzed_hplc < "2021-12-31" ~ "2021",
                              !analyzed_hplc == "2022-11-30" ~ 
                                as.character(analyzed_hplc)))

```

```{r}
#Plotting HPLC and Bulk Chlorophyll for the full Qu39 timeseries including all depths.

bulk_hplc %>%
  filter(line_out_depth < 50) %>% 
  ggplot(aes(x = date, y = chla)) +
  geom_point(aes(fill = chla_flag), pch = 21, size = 3.0) +
  geom_line(size = 1) +
  geom_point(aes(x = date, y = all_chl_a), pch = 22, fill = "green",
             alpha = 0.4, size = 3) +
  facet_grid(line_out_depth ~ .) +
  theme_bw() +
  labs(fill = "Flag") +
  theme(text = element_text(size = 32),
        axis.title.x = element_blank())
  
ggsave(here("figures_qc", "timeseries_qu39_bulk_hplc_full-dataset.png"),
        width = 16, height = 12, dpi = 300)
```

```{r}
#Plotting hplc against bulk chl in scatter plot by bulk chl flag type. Removing SVD flags. NA flags are data that have not been flagged yet.

#Plotting all data with ADL flags a separate group with a separate regression line
bulk_hplc %>%
  filter(chla_flag == "SVC" | chla_flag == "AV" | chla_flag == "ADL" |
           is.na(chla_flag)) %>%
  ggplot(aes(x = all_chl_a, y = chla, fill = chla_flag)) +
  geom_point(pch = 21, size = 3.0) +
  geom_smooth(aes(color = chla_flag), method = 'lm') +
  geom_abline(intercept = 0, slope = 1) +
  xlim(0,25) +
  ylim(0,25) +
  ggtitle("HPLC TChla vs. Fluorometric Chla - QU39") +
  theme_bw() +
  theme()

```

```{r}
#Doing the same plot as above, but faceting by HPLC shipment


#Plotting all data with ADL flags a separate group with a separate regression line
bulk_hplc %>%
  filter(!is.na(shipment)) %>% 
  filter(chla_flag == "AV" | chla_flag == "ADL" |
           is.na(chla_flag)) %>%
  ggplot(aes(x = all_chl_a, y = chla, fill = chla_flag)) +
  geom_point(pch = 21, size = 3.0) +
  geom_smooth(aes(color = chla_flag), method = 'lm') +
  geom_abline(intercept = 0, slope = 1) +
  facet_grid(. ~ shipment) +
  theme_bw() +
  theme()

ggsave(here("figures_qc", "scatter_bulk_hplc_qu39_by-shipment.png"),
        width = 16, height = 4, dpi = 300)
```
```{r}
#Now I want to go shipment by shipment and QC the HPLC data - Chlorophyll QC will be next.
bulk_hplc %>%
  filter(shipment == "2018-05-28") %>% 
  ggplot(aes(x = date)) +
  geom_point(aes(y = chla), pch = 21, size = 3.0) +
  geom_line(aes(y = chla), size = 1) +
  geom_point(aes(y = all_chl_a), pch = 23, size = 2,
             color = "black", fill = "darkgreen", stroke = 1.5) +
  facet_grid(line_out_depth ~ .) +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.title.x = element_blank())

ggsave(here("figures_qc", "timeseries_qu39_hplc_shipment_2018-05-28.png"),
        width = 16, height = 12, dpi = 300)


ship_2018 <- bulk_hplc %>% 
  filter(shipment == "2018-05-28")

#QX18 needs flag (2015-04-14, 5m) - missed bloom
#QX1960 (2016-04-28, 5m) needs a flag - order of magnitude lower than Chl - cross check other measures
#QX3182
#QX3181 (2018-08-22, 5 and 10m) - 5m especially drastically underestimated bloom

#Other than that I think we are ok. Move forward with QCing these data.

```

```{r}
#Now I want to go shipment by shipment and QC the HPLC data - Chlorophyll QC will be next.
bulk_hplc %>%
  filter(shipment == "2019-04-20" & date > "2017-01-01") %>% 
  ggplot(aes(x = date)) +
  geom_point(aes(y = chla, fill = chla_flag), pch = 21, size = 3.0) +
  geom_line(aes(y = chla), size = 1) +
  geom_point(aes(y = all_chl_a), pch = 23, size = 2,
             color = "black", fill = "darkgreen", stroke = 1.5) +
  facet_grid(line_out_depth ~ .) +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.title.x = element_blank())

ggsave(here("figures_qc", "timeseries_qu39_hplc_shipment_2019-04-20.png"),
        width = 16, height = 12, dpi = 300)


ship_2019 <- bulk_hplc %>% 
  filter(shipment == "2019-04-20")

#Some data are not matching because HPLC was collected at the same time as a set of replicates sent to DFO. 2018-04-12. I guess this is where the previos plot where the data were separate would come in handy.

#A lot of variability here, but I think the data is pretty good. Used it all in the manuscript. With exception to 0m data.
```
```{r}
#Now I want to go shipment by shipment and QC the HPLC data - Chlorophyll QC will be next.
bulk_hplc %>%
  filter(shipment == "2019-04-20" & date > "2017-01-01" & date < "2018-01-01") %>% 
  ggplot(aes(x = date)) +
  geom_point(aes(y = chla, fill = chla_flag), pch = 21, size = 3.0) +
  geom_line(aes(y = chla), size = 1) +
  geom_point(aes(y = all_chl_a), pch = 23, size = 2,
             color = "black", fill = "darkgreen", stroke = 1.5) +
  facet_grid(line_out_depth ~ .) +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.title.x = element_blank())

ggsave(here("figures_qc", "timeseries_qu39_hplc_shipment_2019-04-20_2017.png"),
        width = 16, height = 12, dpi = 300)



#Some data are not matching because HPLC was collected at the same time as a set of replicates sent to DFO. 2018-04-12. I guess this is where the previos plot where the data were separate would come in handy.

#A lot of variability here, but I think the data is pretty good. Used it all in the manuscript. With exception to 0m data.
```


```{r}
#Now I want to go shipment by shipment and QC the HPLC data - Chlorophyll QC will be next.
bulk_hplc %>%
  filter(shipment == "2020-03-28") %>% 
  ggplot(aes(x = date)) +
  geom_point(aes(y = chla, fill = chla_flag), pch = 21, size = 3.0) +
  geom_line(aes(y = chla), size = 1) +
  geom_point(aes(y = all_chl_a), pch = 23, size = 2,
             color = "black", fill = "darkgreen", stroke = 1.5) +
  facet_grid(line_out_depth ~ .) +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.title.x = element_blank())

ggsave(here("figures_qc", "timeseries_qu39_hplc_shipment_2020-03-28.png"),
        width = 16, height = 12, dpi = 300)


ship_2020 <- bulk_hplc %>% 
  filter(shipment == "2020-03-28")


#All of this data looks bang on to me

```
```{r}
#Now I want to go shipment by shipment and QC the HPLC data - Chlorophyll QC will be next.
bulk_hplc %>%
  filter(shipment == "2021") %>% 
  ggplot(aes(x = date)) +
  geom_point(aes(y = chla, fill = chla_flag), pch = 21, size = 3.0) +
  geom_line(aes(y = chla), size = 1) +
  geom_point(aes(y = all_chl_a), pch = 23, size = 2,
             color = "black", fill = "darkgreen", stroke = 1.5) +
  facet_grid(line_out_depth ~ .) +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.title.x = element_blank())

ggsave(here("figures_qc", "timeseries_qu39_hplc_shipment_2021.png"),
        width = 16, height = 12, dpi = 300)


ship_2021 <- bulk_hplc %>% 
  filter(shipment == "2021")


#Trends are pretty good, but blooms are underestimated.

```
```{r}
#Now I want to go shipment by shipment and QC the HPLC data - Chlorophyll QC will be next.
bulk_hplc %>%
  filter(shipment == "2022-04-13" & date > "2021-01-01") %>% 
  ggplot(aes(x = date)) +
  geom_point(aes(y = chla), pch = 21, size = 3.0) +
  geom_line(aes(y = chla), size = 1) +
  geom_point(aes(y = all_chl_a), pch = 23, size = 2,
             color = "black", fill = "darkgreen", stroke = 1.5) +
  facet_grid(line_out_depth ~ .) +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.title.x = element_blank())

ggsave(here("figures_qc", "timeseries_qu39_hplc_shipment_2022-04-13.png"),
        width = 16, height = 12, dpi = 300)


ship_2022_04 <- bulk_hplc %>% 
  filter(shipment == "2022-04-13")


#Trends are pretty good, but blooms are underestimated.

```



```{r}
#Now I want to go shipment by shipment and QC the HPLC data - Chlorophyll QC will be next.
bulk_hplc %>%
  filter(shipment == "2022-11-1" | shipment == "2022-11-2") %>% 
  ggplot(aes(x = date)) +
  geom_point(aes(y = chla), pch = 21, size = 3.0) +
  geom_line(aes(y = chla), size = 1) +
  geom_point(aes(y = all_chl_a), pch = 23, size = 2,
             color = "black", fill = "darkgreen", stroke = 1.5) +
  facet_grid(line_out_depth ~ .) +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.title.x = element_blank())

ggsave(here("figures_qc", "timeseries_qu39_hplc_shipment_2022-11.png"),
        width = 16, height = 12, dpi = 300)


ship_2022_11 <- bulk_hplc %>% 
  filter(shipment == "2021-11-1" | shipment == "2022-11-2")


#Trends are pretty good, but blooms are underestimated.

```
That covers all of the HPLC shipments. Just need to apply the flags.

```{r}
#Uploading QC'd HPLC 
```




































