---
title: "Chlorophyll QC"
output: html_notebook
---

This notebook is being made to start a chlorophyll QC process for new incoming samples. 

This is currently configured to only QC new data, but it would be good to have all the data from the time-series to compare new data with long term trends. Just tricky because there are a lot of errors to sift through in the old data (i.e. lots of duplicates, missing records etc. that complicate the checks.)

```{r}
#Upload packages
library(tidyverse)
library(here)
library(patchwork)
library(readxl)
```

```{r}
#Upload chl dataset - entire QU39 dataset downloaded from the portal on 2022-10-12
chl <- read_csv(here("files", "rocky_2021_2022.csv"))

chl_kc10 <- read_csv(here("files", "kc10_2021_2022.csv"))
```


```{r}
#Filtering out the Rocky Intertidal samples
chl <- chl %>% 
  filter(project == "MARINEGEO")

chl_kc10 <- chl_kc10 %>% 
  filter(chla_flag == "AV" | is.na(chla_flag)) %>% 
  filter(line_out_depth == 0 & !filter_type == "Bulk GF/F")

chl_kc10 <- chl_kc10 %>% 
  mutate(ar = before_acid/after_acid)
```

```{r}
#Selecting relevant columns
chl <- chl %>% 
  select(date, site_id, survey, rn, sampling_bout, line_out_depth, collected, 
         analyzed, hakai_id, calibration:calibration_slope, filter_type,
         before_acid, after_acid, acid_flag, dilution_factor, chla, chla_flag,
         phaeo, phaeo_flag) 

#Adding month column
chl <- chl %>% 
  mutate(month = lubridate::month(date)) %>% 
  relocate(month, .after = date)

#Creating duplicate and acid ratio columns
chl <- chl %>% 
  group_by(collected, site_id, line_out_depth, filter_type) %>% 
  mutate(rep = n()) %>%
  ungroup() %>% 
  group_by(hakai_id) %>% 
  mutate(rep_id = n()) %>% 
  ungroup() %>% 
  mutate(acid_ratio = before_acid/after_acid)

#Pulling out duplicates - 33 records. Samples collected on 2022-04-12 were replicate samples with some being sent to DFO (19 records)
check_dup <- chl %>% 
  filter(rep > 1)

#No samples anymore with duplicate Hakai ID.
check_dup_id <- chl %>% 
  filter(rep_id > 1)

```

```{r}
#Diagnostic checks

#Depth check - where were samples collected - only bulk collected at 100 and 115m.
check_depth <- chl %>% 
  distinct(line_out_depth, filter_type)

#Looking at calibrations applied to data - there are some records with NA calibrations
check_cali <- chl %>% 
  distinct(calibration, acid_ratio_correction_factor, acid_coefficient,
           calibration_slope)

#Looking at calibrations that have NA calibration - 308 samples. Many historical and were never analyzed
check_cali_na <- chl %>% 
  filter(is.na(calibration))

#Looking for negative values - lots (105 records), including unflagged data.
check_neg <- chl %>% 
  filter(chla < 0 | phaeo < 0)

#There are lots and I need to investigate this - same output as samples that weren't 
check_na <- chl %>% 
  filter(is.na(chla) | is.na(phaeo))

#Checking if there are any pre-existing flags - huge amount of samples flagged. I went through these pretty carefully and they should be pretty good. 4 samples with NA Chl flags and SVD phaeo flags.
check_flag <- chl %>% 
  filter(!is.na(chla_flag) | !is.na(phaeo_flag))

#Checking acid flag 
check_acid_flag <- chl %>% 
  filter(!is.na(acid_flag))

#Looking for filters with low acid ratios -  quite a few for data that hasn't been flagged yet.
check_ar <- chl %>% 
  filter(acid_ratio < 1.2)
```


```{r}
#Plotting acid ratio value numbers by depth and filter size for all data I have flagged as Accepted Value
check_ar %>% 
  # filter(is.na(chla_flag)) %>% 
  # filter(chla_flag == "AV") %>% 
  ggplot(aes(x = site_id, fill = filter_type)) +
  geom_bar(stat = "count", position = "stack", color = "Black") +
  labs(x = "Site",
       y = "count") +
  theme_bw()
```
```{r}
#Plotting acid ratio value numbers by month and filter size for all data I have flagged as Accepted Value - Not super informative
check_ar %>% 
  # filter(is.na(chla_flag)) %>% 
  # filter(chla_flag == "AV" & line_out_depth < 50) %>% 
  ggplot(aes(x = as.factor(month), fill = filter_type)) +
  geom_bar(stat = "count", position = "stack", color = "Black") +
  labs(x = "depth",
       y = "count") +
  theme_bw() + 
  facet_grid(site_id ~ .)
```


```{r}
#checking samples that were diluted. Need to determine when we started doing this.
check_dilution <- chl %>% 
  filter(dilution_factor > 1)

#Looking at samples that haven't been qc'd that have raw values above instrument threshold - good sign, only 1 and not above threshold.
check_adl <- chl %>% 
  filter(!is.na(analyzed) & is.na(chla_flag) & before_acid > 600000)
```


```{r}
#Pulling out all samples that haven't been QC'd on the new module. 
chl_qc <- chl %>% 
  filter(!is.na(analyzed) &
           (is.na(chla_flag) | chla_flag == "AV" | chla_flag == "ADL"))

#Pulling out all QC'd data
chl_av <- chl %>% 
  filter(chla_flag == "AV")

```

Does this give me enough to fully QC the Bulk data?

```{r}
#Investigating size-fractionated data for errors.

#Calculating the number of filters for each size-fraction set
chl_sf <- chl %>% 
  filter(!is.na(chla)) %>% 
  group_by(collected, line_out_depth) %>% 
  mutate(filt_num = n()) %>% 
  ungroup()

#Looking for size fraction sets that have less than 3 filters - 119 observations - I'd imagine a lot of SVC and SVD flags for single filter.
check_sf_low <- chl_sf %>% 
  filter(filt_num < 3)

check_sf_low2 <- chl_sf %>% 
  filter(filt_num < 6)

#Looking at size fraction sets that have more than 3 filters. Some are just replicated hakai IDS, but quite a few from zoopsprint - I wonder if one of the GF/Fs is meant to be bulk.
check_sf_high <- chl_sf %>% 
  filter(filt_num > 3)

#Subsetting where there are 3 size-fractionated filters. 
chl_sf <- chl_sf %>% 
  filter(filt_num == 3)

#Querying replicated filter types within a set - two examples where there are two duplicated filters within a 3 filter set. Only one is not QC'd - check metadata note.
check_sf_dup <- chl_sf %>% 
  group_by(collected, line_out_depth, filter_type) %>% 
  mutate(filt_unique = n()) %>% 
  ungroup() %>% 
  filter(filt_unique > 1)  
 

chl_sf <- chl_sf %>% 
  group_by(collected, line_out_depth, filter_type) %>% 
  mutate(filt_unique = n()) %>% 
  ungroup() %>% 
  filter(filt_unique == 1)
  
```

```{r}
gff <- chl %>% 
  filter(filter_type == "GF/F" & !is.na(chla)) %>% 
  select(date, site_id, sampling_bout, acid_ratio, chla) 

gff_wide <- gff %>% 
  pivot_wider(names_from = sampling_bout, values_from = c(chla, acid_ratio))
```

```{r}
f_gff <- gff_wide %>% 
  ggplot(aes(x = chla_1, y = chla_2)) + 
  geom_point(pch = 21, size = 3.5, fill = "black") +
  geom_smooth(method = 'lm', color = "red") +
  geom_abline(intercept = 0, slope = 1, size = 1) +
  ggpubr::stat_cor(p.accuracy = 0.001, r.accuracy = 0.01, size = 10) +
  xlim(0, 1.25) +
  ylim(0, 1.25) +
  xlab(bquote("Chla"[GFF]~"-1" ~ "(ug/L)")) +
  ylab(bquote("Chla"[GFF]~"-2" ~ "(ug/L)")) +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.text = element_text(colour = "black"),
        # axis.text.y = element_blank(),
        # axis.title.y = element_blank(),
        legend.position = "none") +
  labs(fill = "Date", shape = "Station") +
  guides(fill = guide_legend(override.aes = list(shape = 21)))
```

```{r}
um3 <- chl %>% 
  filter(filter_type == "3um" & !is.na(chla)) %>% 
  select(date, site_id, filter_type, sampling_bout, acid_ratio, chla) 

um3_wide <- um3 %>% 
  filter(!date == "2021-06-25") %>% 
  pivot_wider(names_from = sampling_bout, values_from = c(chla, acid_ratio))
```

```{r}
f_3um <- um3_wide %>% 
  ggplot(aes(x = chla_1, y = chla_2)) + 
  geom_point(pch = 21, size = 3.5, fill = "black") +
  geom_smooth(method = 'lm', color = "red") +
  geom_abline(intercept = 0, slope = 1, size = 1) +
  ggpubr::stat_cor(p.accuracy = 0.001, r.accuracy = 0.01, size = 10) +
  xlim(0, 1.5) +
  ylim(0, 1.5) +
  xlab(bquote("Chla"["3um"]~"-1" ~ "(ug/L)")) +
  ylab(bquote("Chla"["3um"]~"-2" ~ "(ug/L)")) +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.text = element_text(colour = "black"),
        # axis.text.y = element_blank(),
        # axis.title.y = element_blank(),
        legend.position = "none") +
  labs(fill = "Date", shape = "Station") +
  guides(fill = guide_legend(override.aes = list(shape = 21)))
```

```{r}
um3 %>% 
  ggplot(aes(x = acid_ratio)) +
  geom_histogram(binwidth = 0.05, alpha = 0.5, color = "black") +
  ylim(0, 15)
```


```{r}
um20 <- chl %>% 
  filter(filter_type == "20um" & !is.na(chla)) %>% 
  select(date, site_id, sampling_bout, filter_type, acid_ratio, chla) 

um20_wide <- um20 %>% 
  pivot_wider(names_from = sampling_bout, values_from = c(chla, acid_ratio))
```

```{r}
f_20um <- um20_wide %>% 
  ggplot(aes(x = chla_1, y = chla_2)) + 
  geom_point(pch = 21, size = 3.5, fill = "black") +
  geom_smooth(method = 'lm', color = "red") +
  geom_abline(intercept = 0, slope = 1, size = 1) +
  ggpubr::stat_cor(p.accuracy = 0.001, r.accuracy = 0.01, size = 10) +
  xlim(0, 3.25) +
  ylim(0, 3.25) +
  xlab(bquote("Chla"["20um"]~"-1" ~ "(ug/L)")) +
  ylab(bquote("Chla"["20um"]~"-2" ~ "(ug/L)")) +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.text = element_text(colour = "black"),
        # axis.text.y = element_blank(),
        # axis.title.y = element_blank(),
        legend.position = "none") +
  labs(fill = "Date", shape = "Station") +
  guides(fill = guide_legend(override.aes = list(shape = 21)))
```

```{r}
chl_2 <- chl %>% 
  filter(!is.na(chla)) %>% 
  group_by(date, sampling_bout, filter_type) %>% 
  mutate(rep_filt = n()) %>% 
  ungroup()

chl_2 <- chl_2 %>% 
  filter(!is.na(chla)) %>% 
  group_by(date, sampling_bout) %>% 
  mutate(rep_filt_grp = n()) %>% 
  ungroup()

chl_sf <- chl_2 %>% 
  filter(rep_filt == 1 & rep_filt_grp == 3) %>% 
  group_by(date, sampling_bout) %>% 
  summarise(chla_sum = sum(chla)) %>% 
  ungroup()
  
sum <- chl_sf %>% 
  select(date, sampling_bout, chla_sum) 

sum_wide <- sum %>% 
  pivot_wider(names_from = sampling_bout, values_from = chla_sum) %>% 
  rename(sum_1 = `1`, sum_2 = `2`)
```

```{r}
f_sf_sum <- sum_wide %>% 
  ggplot(aes(x = sum_1, y = sum_2)) + 
  geom_point(pch = 21, size = 3.5, fill = "black") +
  geom_smooth(method = 'lm', color = "red") +
  geom_abline(intercept = 0, slope = 1, size = 1) +
  ggpubr::stat_cor(p.accuracy = 0.001, r.accuracy = 0.01, size = 10) +
  xlim(0, 6) +
  ylim(0, 6) +
  xlab(bquote("Chla"["SF-Sum"]~"-1" ~ "(ug/L)")) +
  ylab(bquote("Chla"["SF-Sum"]~"-2" ~ "(ug/L)")) +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.text = element_text(colour = "black"),
        # axis.text.y = element_blank(),
        # axis.title.y = element_blank(),
        legend.position = "none") +
  labs(fill = "Date", shape = "Station") +
  guides(fill = guide_legend(override.aes = list(shape = 21)))
```

```{r}
fig <- f_gff + f_3um + f_20um + f_sf_sum

ggsave(here("figures_qc", "scatter_rocky_duplicate.png"), fig,
       width = 16, height = 16, dpi = 300)
```
```{r}

mean <- um20 %>% 
  summarise(median = mean(acid_ratio))

f1 <- gff %>% 
  ggplot(aes(x = acid_ratio)) +
  geom_histogram(binwidth = 0.05, alpha = 0.5, color = "black") +
  geom_vline(xintercept = 1.28) +
  ylim(0, 15) +
  xlim(1.0, 1.8) +
  xlab(bquote("AR"["GFF"])) +
  ylab("ROCKY Sample #") +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.text = element_text(colour = "black"),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none") 

f2 <- um3 %>% 
  ggplot(aes(x = acid_ratio)) +
  geom_histogram(binwidth = 0.05, alpha = 0.5, color = "black") +
   geom_vline(xintercept = 1.27) +
  ylim(0, 15) +
  xlim(1.0, 1.8) +
  xlab(bquote("AR"["3um"])) +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.text = element_text(colour = "black"),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none") 

f3 <- um20 %>% 
  ggplot(aes(x = acid_ratio)) +
  geom_histogram(binwidth = 0.05, alpha = 0.5, color = "black") +
  geom_vline(xintercept = 1.25) +
  ylim(0, 15) +
  xlim(1.0, 1.8) +
  xlab(bquote("AR"["20um"])) +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.text = element_text(colour = "black"),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "none")

mean2 <- chl_kc10 %>% 
  filter(!is.na(ar)) %>% 
  group_by(filter_type) %>% 
  summarise(mean = mean(ar))


f4 <- chl_kc10 %>% 
  filter(filter_type == "GF/F") %>% 
  ggplot(aes(x = ar)) +
  geom_histogram(binwidth = 0.05, alpha = 0.5, color = "black") +
  geom_vline(xintercept = 1.42) +
  ylim(0, 8) +
  xlim(1.0, 1.8) +
  xlab(bquote("AR"["GFF"])) +
  ylab("KC10 Sample #") +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.text = element_text(colour = "black"),
        # axis.text.y = element_blank(),
        # axis.title.y = element_blank(),
        legend.position = "none") 

f5 <- chl_kc10 %>% 
  filter(filter_type == "3um") %>% 
  ggplot(aes(x = ar)) +
  geom_histogram(binwidth = 0.05, alpha = 0.5, color = "black") +
  geom_vline(xintercept = 1.51) +
  ylim(0, 8) +
  xlim(1.0, 1.8) +
  xlab(bquote("AR"["3um"])) +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.text = element_text(colour = "black"),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "none") 

f6 <- chl_kc10 %>% 
  filter(filter_type == "20um") %>% 
  ggplot(aes(x = ar)) +
  geom_histogram(binwidth = 0.05, alpha = 0.5, color = "black") +
  geom_vline(xintercept = 1.50) +
  ylim(0, 8) +
  xlim(1.0, 1.8) +
  xlab(bquote("AR"["20um"])) +
  theme_bw() +
  theme(text = element_text(size = 32),
        axis.text = element_text(colour = "black"),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "none") 


ar_fig <- f1 + f2 + f3 + f4 + f5 +f6

ggsave(here("figures_qc", "histo_ar_rocky.png"), ar_fig,
       width = 16, height = 12, dpi = 300)

```
















































