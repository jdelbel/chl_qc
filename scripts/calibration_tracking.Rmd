---
title: "R Notebook"
output: html_notebook
---

This script is meant to track the Trilogy benchtop chlorophyll fluorometer calibrations. Issues with historical calibrations are also diagnosed.

```{r}
#Load packages
library(tidyverse)
library(readxl)
library(here)
library(broom)
library(patchwork)
```

```{r}
#Upload calibration sheet
cali <- read_xlsx(here("files", "instrument_calibrations.xlsx"))

#Upload Chlorophyll data for comparison between
chl <- read_xlsx(here("files", "hakai_chl_all.xlsx"), sheet = "Hakai Data")
```

```{r}
#Trying to calculate information here to see if it lines up with what I did in Excel

#Subtracting the blank before acid  value from the raw before acid value. Renaming using convention rb as "raw before acid" and ra as "raw after acid"
cali_manip <- cali %>% 
  mutate(rb_blank_corr = `Raw Before Acid` - `Blank Before Acid`)
         
#Since a blank after acid value was only available for later calibrations, I subtract the blank before acid values when not available and blank after acid value when it is available         
cali_manip <- cali_manip %>% 
  mutate(`Blank After Acid` = coalesce(`Blank After Acid`, 0)) %>% 
  mutate(ra_blank_corr = case_when(`Blank After Acid` == 0  ~ `Raw After Acid` - `Blank Before Acid`,
                          `Blank After Acid` > 0  ~ `Raw After Acid` - `Blank After Acid`))

#Calculating the acid ratio (FM) and making sure it is the same as those calculated in excel.                      
cali_manip <- cali_manip %>%
  mutate(fm_blank_corr = rb_blank_corr/ra_blank_corr,
         fm_comp = fm_blank_corr - `FM (Blank Subtracted)`)

#Flagging fm that fall outside of the expected range, these should not be used for deriving calibration values. The low values generally occur as a result of standard concentrations that were too low. It also seems like slight acid contaimination may have been an issue for the Hakai calibrations. It is unclear why very high fm values occured.
cali_manip <- cali_manip %>% 
  mutate(fm_flag = case_when(fm_blank_corr < 1.60 | fm_blank_corr > 1.90 ~ "SVC",
                             fm_blank_corr > 1.60 & fm_blank_corr <1.90 ~ "AV"))


#Removing columns I don't need -  Should Really add the slope I derived in excel and that is currently applied to the data on the portal.
cali_manip <- cali_manip %>% 
  select(date = Date, flu_num = `Fluorometer #`, 
         chl_std_conc = `chl standard concentration`, bb = `Blank Before Acid`,
         ba = `Blank After Acid`, rb = `Raw Before Acid`, ra = `Raw After Acid`,
         rb_blank_corr:fm_blank_corr, fm_flag, 
         excel_chl = `Calc. Chl`, excel_phaeo = `Calc. Phaeo`, lab)

#Calculating ratio of raw count to chl standard to investigate variability in slope
cali_manip <- cali_manip %>% 
  mutate(slope_ratio = chl_std_conc/rb_blank_corr)

```

```{r}
p1 <- cali_manip %>% 
  filter(flu_num == "720000982" & fm_flag == "AV" & 
           !as.character(date) == "2018-04-17") %>% 
  ggplot(aes(rb_blank_corr, chl_std_conc)) +
  geom_point(aes(fill = factor(date), shape = lab), size = 3, pch = 21, color = "black", 
             stroke = 1) +
  stat_smooth(aes(color = factor(date)), method = "lm", formula = y ~ x - 1,
              se = FALSE, fullrange = T) +
  scale_x_continuous(expand = c(0, 0), limits=c(0, 550000)) +
  scale_y_continuous(expand = c(0, 0), limits=c(-50, 320)) +
  coord_cartesian(xlim=c(0, 550000), ylim=c(0, 320)) +
  scale_fill_brewer(palette = "Dark2", name = "Cali. Date") +
  scale_color_brewer(palette = "Dark2", name = "Cali. Date") +
  labs(x = "Instrument Raw #",
       y = "Chl. Stand. Conc. (ug/L)",
       title = "Instrument # 0982") +
  theme_bw() +
  theme(legend.position = c(0.83, 0.16),
        text = element_text(size = 20)) 

p2 <- cali_manip %>% 
  filter(flu_num == "720001154" & fm_flag == "AV" & 
           !as.character(date) == "2018-04-17") %>% 
  ggplot(aes(rb_blank_corr, chl_std_conc)) +
  geom_point(aes(fill = factor(date)), size = 3, pch = 21, color = "black",
             stroke = 1) +
  stat_smooth(aes(color = factor(date)), method = "lm", formula = y ~ x - 1,
              se = FALSE, fullrange = T) +
  scale_x_continuous(expand = c(0, 0), limits=c(0, 550000)) +
  scale_y_continuous(expand = c(0, 0), limits=c(-50, 320)) +
  coord_cartesian(xlim=c(0, 550000), ylim=c(0, 320)) +
  scale_fill_brewer(palette = "Dark2", name = "Cali. Date") +
  scale_color_brewer(palette = "Dark2", name = "Cali. Date") +
  labs(x = "Instrument Raw #",
       y = "Chl. Stand. Conc. (ug/L)",
       title = "Instrument # 1154") +
  theme_bw() +
  theme(legend.position = c(0.83, 0.19),
        axis.title.y = element_blank(),
        # axis.text.y = element_blank(),
        text = element_text(size = 20))

fig <- p1 + p2

ggsave(here("figures", "Calibration_compare_2.png"), 
       fig, width = 14, height = 7.5, dpi = 300)
```

```{r}
#Determining linear model statistics - intercept set to 0
fitted_models <- cali_manip %>% 
  filter(fm_flag == "AV") %>% 
  group_by(date, flu_num) %>% 
  do(tidy(lm(chl_std_conc ~ 0 + rb_blank_corr, data = .))) %>% 
  ungroup() %>% 
  arrange(flu_num, date)

#Determining linear model statistics - intercept set to 0
fitted_models_r2 <- cali_manip %>% 
  filter(fm_flag == "AV") %>% 
  group_by(date, flu_num) %>% 
  do(glance(lm(chl_std_conc ~ 0 + rb_blank_corr, data = .))) %>% 
  ungroup() %>% 
  arrange(flu_num, date) %>% 
  select(date, flu_num, r2 = r.squared) %>% 
  mutate_at(vars(r2), funs(round(., 5)))
  
fitted_models <- fitted_models %>% 
  left_join(fitted_models_r2)

#Reassigning lab to fitted model outputs
lab <- cali_manip %>% 
  select(date, flu_num, lab) %>% 
  distinct() 

fitted_models <- fitted_models %>% 
  left_join(lab)

#Determining mean fm value for each calibration
cali_fm <- cali_manip %>% 
  filter(fm_flag == "AV") %>% 
  group_by(date, flu_num) %>% 
  mutate(mean_fm = mean(fm_blank_corr),
         mean_slope_ratio = mean(slope_ratio))

#Merging calibration slope from linear model with fm value
cali_values <- fitted_models %>% 
  left_join(cali_fm) %>% 
  distinct(date, flu_num, .keep_all = TRUE) %>% 
  select(date:p.value, r2, mean_fm, mean_slope_ratio, lab)

#isolating calibration values currently utilized on the portal - NAs are showing up. This is a problem
cali_portal <- chl %>% 
  select(flurometer_serial_no:calibration_slope) %>% 
  distinct(.keep_all = TRUE) %>% 
  filter(!is.na(calibration)) %>% 
  rename(flu_num = flurometer_serial_no, date = calibration) %>% 
  mutate(flu_num = as.numeric(flu_num))

#merging with R determined slopes and fm values
cali_values <- cali_values %>% 
  left_join(cali_portal)

#For Instrument 1154, applying the back-calibrating from the first DFO 
chl_corrected_1154 <- chl %>% 
  filter(filter_type == "Bulk GF/F" & flurometer_serial_no == "720001154" &
           !is.na(calibration) & !is.na(before_acid) & !is.na(after_acid)) %>% 
  select(date, volume, acetone_volume_ml, flurometer_serial_no:after_acid, chla) %>% 
  mutate(chl_dfo = 0.0005424382*
                (1.683012/(1.683012 - 1))*
                (before_acid - after_acid)*
                (acetone_volume_ml/volume),
         rel_diff = ((chl_dfo - chla)/chla) * 100) %>% 
  mutate_at(vars(rel_diff), funs(round(., 2)))

chl_corrected_0982 <- chl %>% 
  filter(filter_type == "Bulk GF/F" & flurometer_serial_no == "720000982" &
           !is.na(calibration) & !is.na(before_acid) & !is.na(after_acid)) %>% 
  select(date, volume, acetone_volume_ml, flurometer_serial_no:after_acid, chla) %>% 
  mutate(chl_dfo = 0.0006425000*
                (1.831313/(1.831313 - 1))*
                (before_acid - after_acid)*
                (acetone_volume_ml/volume),
         rel_diff = ((chl_dfo - chla)/chla) * 100) %>% 
  mutate_at(vars(rel_diff), funs(round(., 2)))

```

```{r}
p1 <- cali_values %>% 
  filter(flu_num == 720001154 & 
           !as.character(date) == "2018-04-17") %>% 
  mutate(slope = estimate*10000,
         se = std.error*10000) %>% 
  ggplot(aes(factor(date), slope, fill = lab)) +
  geom_point(size = 6, pch = 21, color = "black") +
  geom_text(aes(label = r2), vjust = - 0.8, size = 7) +
  geom_errorbar(aes(ymin = slope - se, ymax = slope + se), width = .3, size = 1) +
  theme_bw() +
  ylim(4, 7) +
  labs(title = "Instrument #1154",
       y = "Calibration Slope",
       x = "Cali. Date") +
  scale_fill_brewer(palette = "Set1") +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        text = element_text(size = 28),
        axis.text = element_text(colour = "black")) 

p2 <- cali_values %>% 
  filter(flu_num == 720000982 & 
           !as.character(date) == "2018-04-17") %>% 
  mutate(slope = estimate*10000,
         se = std.error*10000) %>% 
  ggplot(aes(factor(date), slope, fill = lab)) +
  geom_point(size = 6, pch = 21, color = "black") +
  geom_text(aes(label = r2), vjust = - 0.8, size = 7) +
  geom_errorbar(aes(ymin = slope - se, ymax = slope + se), width = .3, size = 1) +
  theme_bw() +
  ylim(4, 7) +
  labs(title = "Instrument #0982",
       x = "Cali. Date") +
  scale_fill_brewer(palette = "Set1", name = "Cali. Lab") +
  theme(legend.position = c(0.83, 0.16),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        text = element_text(size = 28),
        axis.text = element_text(colour = "black")) 

p3 <- cali_manip %>% 
  filter(fm_flag == "AV" & flu_num == 720001154 & !as.character(date) == "2018-04-17") %>%
  ggplot(aes(factor(date), fm_blank_corr, fill = lab)) +
  geom_boxplot() +
  theme_bw() +
  ylim(1.6, 1.9) +
  labs(y = "Acid Ratio (fm)",
       x = "Cali. Date") +
  scale_fill_brewer(palette = "Set1") +
  theme(legend.position = "none",
        text = element_text(size = 28),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(colour = "black"))
  

p4 <- cali_manip %>% 
  filter(fm_flag == "AV" & flu_num == 720000982 & !as.character(date) == "2018-04-17") %>% 
  ggplot(aes(factor(date), fm_blank_corr, fill = lab)) +
  geom_boxplot() +
  theme_bw() +
  ylim(1.6, 1.9) +
  ylim(1.6, 1.9) +
  labs(y = "Acid Ratio (fm)",
       x = "Cali. Date") +
  scale_fill_brewer(palette = "Set1") +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        text = element_text(size = 28),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(colour = "black"))
  
fig <- p1 + p2 + p3 + p4

ggsave(here("figures", "slope_fm_compare.png"), fig , width=16, height=15, dpi=300)
```


```{r}
#Plot relative difference
p1 <- chl_corrected_1154 %>%
  filter(!as.character(calibration) == "2019-05-09") %>% 
  distinct(calibration, .keep_all = TRUE) %>%  
  mutate(pos = rel_diff > 0) %>% 
  ggplot(aes(x = factor(calibration), y = rel_diff, fill = pos)) +
  geom_col(position = "identity", colour = "black") +
  geom_hline(yintercept = 0) +
  geom_text(aes(label = rel_diff), vjust = - 0.5, size = 7) +
  scale_fill_manual(values = c("#007FFF", "#FF6347"), guide = FALSE) +
  lims(y = c(-40, 40)) +
  theme_bw() +
  labs(x = "Calibration Date",
       y = "% Diff. Hakai vs DFO Cali. Chl",
       title = "Instrument #1154") +
  theme(text = element_text(size = 28),
        axis.text = element_text(colour = "black"))
  
p2 <- chl_corrected_0982 %>%
  filter(!as.character(calibration) == "2019-05-09" &
           !as.character(calibration) == "2018-05-04") %>% 
  distinct(calibration, .keep_all = TRUE) %>%  
  mutate(pos = rel_diff > 0) %>% 
  ggplot(aes(x = factor(calibration), y = rel_diff, fill = pos)) +
  geom_col(position = "identity", colour = "black", width = 0.5) +
  geom_hline(yintercept = 0) +
  geom_text(aes(label = rel_diff), vjust = - 0.5, size = 7) +
  scale_fill_manual(values = c("#007FFF", "#FF6347"), guide = FALSE) +
  lims(y = c(-40, 40)) +
  theme_bw() +
  labs(x = "Calibration Date",
       y = "% Diff. Hakai vs DFO Cali. Chl",
       title = "Instrument #0982") +
  theme(text = element_text(size = 28),
        axis.text = element_text(colour = "black"))

fig <- p1/p2


ggsave(here("figures", "Cali_red_diff.png"), fig, width=16, height=12, dpi=300)
```
```{r}
test <- chl_corrected_1154 %>% 
  filter(as.character(calibration) == "2017-01-08") %>% 
  mutate(test = calibration_slope*
                (acid_coefficient/(acid_coefficient - 1))*
                (before_acid - after_acid)*
                (acetone_volume_ml/volume),
         test2 = (acid_coefficient/(acid_coefficient - 1)),
         test3 = 0.0005424382*
                (1.683012/(1.683012 - 1))*
                (before_acid - after_acid)*
                (acetone_volume_ml/volume))
```

















